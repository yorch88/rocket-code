# 🚀 rocket-code API (FastAPI + PostgreSQL + Redis)

A professional **Article Management Service** ready for demo or client deployment.

- FastAPI + router/service/repository architecture  
- PostgreSQL and Redis (cache by `article:{id}` with TTL 90s)  
- Mandatory API Key (`x-api-key`)  
- Rate limiting: **60 req/min** per API Key  
- Alembic, Docker, testing, and CI (pytest + ruff + black)

---

## 🧱 API Endpoints

| Method | Endpoint | Description |
|---------|-----------|-------------|
| `POST` | `/articles` | Create a new article |
| `GET` | `/articles/{id}` | Get article by ID |
| `PUT` | `/articles/{id}` | Update article |
| `DELETE` | `/articles/{id}` | Delete article |
| `GET` | `/articles` | List all articles |
| `GET` | `/articles/search?q=` | Search articles |
| `GET` | `/health` | Health check (DB + Redis) |

---

## ⚙️ Makefile — Useful Commands

- `make env` → Copy `.env.example` → `.env` (if not existing)  
- `make up-build` → **Build and start services** for the first time  
- `make up` → Bring up all containers (detached mode)  
- `make down` → Stop and remove containers (includes volumes)  
- `make migrate` → Run Alembic migrations (`upgrade head`)  
- `make revision m="message"` → Create an autogenerated migration  
- `make api-bash` / `make db-psql` → Quick access to API or DB containers  
- `make lint` / `make fmt` → Run Ruff and Black formatters  
- `make test` → Run **unit tests** inside the container  
- `make test-int` → Run **integration tests** against the full stack  
- `make curl-health` → Check `/health` endpoint  
- `make status` → Show Docker container status  
- `make lint-full` → Run Linters all project
---

## 🧪 Testing Instructions

### ▶️ 1. Start the app for the first time
```bash
make up-build


# 🚀 Article API Test Guide with Redis Cache

This guide explains how to test the complete flow of **creating, retrieving, and verifying cache in Redis** within the article service.

---

## 🧩 Step 1: Create a New Article

Run the following **POST** request to create an article:

```bash
curl -s -X POST "http://127.0.0.1:8000/articles" \
  -H "Content-Type: application/json" \
  -H "x-api-key: 47da9ef4-0a22-4625-89f3-ef7025a64192" \
  -d '{
    "title": "x Ray test",
    "body": "test body",
    "tags": "development",
    "author": "yorch"
  }'
```

You should get a response similar to:

```json
{
  "id": 3,
  "title": "x Ray test",
  "author": "yorch",
  ...
}
```

---

## 🧩 Step 2: Retrieve the Article by ID

Using the returned `id` (e.g., `3`), run the following **GET**:

```bash
curl -s "http://127.0.0.1:8000/articles/3" \
  -H "x-api-key: 47da9ef4-0a22-4625-89f3-ef7025a64192"
```

🔹 **First time:**  
The backend queries the database and stores the result in Redis.  
If you enable logs in `rocket-api`, you should see something like:

```
Cache miss, fetching from DB
```

---

## 🧩 Step 3: Query Again (Cache Hit)

Run the same command again:

```bash
curl -s "http://127.0.0.1:8000/articles/3" \
  -H "x-api-key: 47da9ef4-0a22-4625-89f3-ef7025a64192"
```

🔹 **This time:**  
The backend should respond faster because the article is now retrieved from Redis cache.

---

## 🧩 Step 4: Verify in Redis Directly

Open the Redis client using Docker:

```bash
docker compose exec redis redis-cli
```

Then run the following commands:

```bash
KEYS article:*
TTL article:3
```

You should see output similar to:

```
1) "article:3"
(integer) 60
```

🔹 This confirms that:
- The key `article:3` is stored in Redis.  
- It has a TTL (e.g., **60–90 seconds**) based on your `CACHE_TTL_SECONDS` configuration.

---

## 🧩 Step 5: Let the Cache Expire

After about **90 seconds** (your current TTL), run again:

```bash
docker compose exec redis redis-cli
KEYS article:*
```

👉 The key `article:3` should **no longer appear**, since it expired automatically.

---

## 🧩 Example Redis Session

```bash
...@ubuntu ~/Documents/rocketcode/rocket-code (main)
$ make redis-cli
127.0.0.1:6379> KEYS article:*
1) "article:3"
127.0.0.1:6379> TTL article:3
(integer) 82
127.0.0.1:6379> KEYS article:*
1) "article:6"
127.0.0.1:6379> TTL article:6
(integer) 79
127.0.0.1:6379>
```

---

## ✅ Summary

| Action | Description | Expected Result |
|--------|--------------|-----------------|
| **POST /articles** | Creates a new article | Returns `id` |
| **GET /articles/{id}** (1st time) | Fetches from DB and stores in Redis | Cache created |
| **GET /articles/{id}** (2nd time) | Fetches from cache | Faster response |
| **Redis CLI → KEYS / TTL** | Verifies cached keys | Active TTL |
| **Wait for TTL** | Cache expires automatically | Key disappears |

---

> 💡 **Tip:**  
> You can adjust the `CACHE_TTL_SECONDS` variable in your `.env` file or configuration to change how long keys remain cached in Redis.
